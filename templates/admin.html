<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interface Animateur</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body class="admin-page">
    <div class="admin-container">
        <header class="admin-header">
            <h1>üéØ Interface Animateur</h1>
            <div class="game-status">
                <span id="question-counter">Question 0/0</span>
                <span id="timer-display">50s</span>
            </div>
        </header>

        <div class="admin-content">
            <div class="question-panel">
                <h3>Question actuelle</h3>
                <div id="current-question">Cliquez sur "D√©marrer" pour commencer</div>
                <div id="correct-answer" class="answer-display"></div>
            </div>

            <div class="buzzer-panel">
                <h3>√âtat du buzzer</h3>
                <div id="buzzer-status">En attente...</div>
                <div class="buzzer-controls">
                    <button id="correct-btn" onclick="correctAnswer()" disabled>‚úÖ Correct</button>
                    <button id="wrong-btn" onclick="wrongAnswer()" disabled>‚ùå Incorrect</button>
                </div>
            </div>

            <div class="game-controls">
                <button id="start-btn" onclick="startGame()">üöÄ D√©marrer le jeu</button>
                <button id="next-btn" onclick="nextQuestion()" style="display:none;">‚û°Ô∏è Question suivante</button>
            </div>

            <div class="players-panel">
                <h3>Joueurs connect√©s</h3>
                <div id="players-list"></div>
            </div>
        </div>
    </div>

    <audio id="buzzer-sound" preload="auto">
        <source src="{{ url_for('static', filename='buzzer.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="timer-sound" preload="auto">
        <source src="{{ url_for('static', filename='timer.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="correct-sound" preload="auto">
        <source src="{{ url_for('static', filename='correct.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="wrong-sound" preload="auto">
        <source src="{{ url_for('static', filename='wrong.mp3') }}" type="audio/mpeg">
    </audio>

    <script>
        const socket = io();
        let gameData = {};

        function startGame() {
            socket.emit('start_game');
            document.getElementById('start-btn').style.display = 'none';
        }

        function correctAnswer() {
            document.getElementById('correct-sound').play().catch(e => {});
            socket.emit('correct_answer');
            disableBuzzerControls();
        }

        function wrongAnswer() {
            document.getElementById('wrong-sound').play().catch(e => {});
            socket.emit('wrong_answer');
            disableBuzzerControls();
        }

        function nextQuestion() {
            socket.emit('next_question');
        }

        function disableBuzzerControls() {
            document.getElementById('correct-btn').disabled = true;
            document.getElementById('wrong-btn').disabled = true;
        }

        function enableBuzzerControls() {
            document.getElementById('correct-btn').disabled = false;
            document.getElementById('wrong-btn').disabled = false;
        }

        socket.on('game_update', function(data) {
            gameData = data;
            
            if (data.current_question) {
                document.getElementById('question-counter').textContent = 
                    `Question ${data.question_number}/${data.total_questions}`;
                document.getElementById('current-question').textContent = data.current_question.question;
                document.getElementById('correct-answer').textContent = 
                    `R√©ponse: ${data.current_question.answer}`;
            }

            updatePlayersList();
            
            if (!data.buzzer_pressed) {
                document.getElementById('buzzer-status').textContent = 'En attente...';
                disableBuzzerControls();
            }
        });

        socket.on('buzzer_activated', function(data) {
            // Essayer le fichier MP3, sinon g√©n√©rer un son
            const audio = document.getElementById('buzzer-sound');
            audio.play().catch(e => {
                // Fallback: g√©n√©rer un son
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.type = 'square';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                } catch(err) {
                    console.log('Son non disponible');
                }
            });
            
            document.getElementById('buzzer-status').innerHTML = 
                `<strong>${data.player}</strong> a buzz√© !`;
            enableBuzzerControls();
        });

        socket.on('game_finished', function() {
            document.getElementById('buzzer-status').textContent = 'Jeu termin√© !';
            alert('Le jeu est termin√© ! Consultez les r√©sultats sur l\'√©cran de projection.');
        });

        socket.on('time_warning', function() {
            document.getElementById('timer-sound').play().catch(e => {});
        });

        function updatePlayersList() {
            const sortedPlayers = Object.entries(gameData.players || {})
                .sort(([,a], [,b]) => b.score - a.score);
            
            const playersList = document.getElementById('players-list');
            playersList.innerHTML = '';
            
            sortedPlayers.forEach(([name, data]) => {
                const div = document.createElement('div');
                div.className = 'admin-player';
                div.innerHTML = `<span>${name}</span><span>${data.score} pts</span>`;
                playersList.appendChild(div);
            });
        }

        socket.on('connect', function() {
            console.log('Animateur connect√©');
        });
    </script>
</body>
</html>