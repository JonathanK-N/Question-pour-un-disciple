<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>&Eacute;cran de projection</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body class="display-page">
    <div class="display-container">
        <header class="display-header">
            <h1>🏆 Question pour un Disciple 🏆</h1>
            <div class="timer-section">
                <div id="timer">20</div>
                <div class="timer-bar">
                    <div id="timer-progress"></div>
                </div>
            </div>
            <button id="fullscreen-btn" onclick="toggleFullscreen()">📺 Plein &eacute;cran</button>
        </header>

        <main class="display-main">
            <div class="question-display">
                <div id="question-number">En attente...</div>
                <div id="question-text">Le jeu va bientôt commencer&nbsp;!</div>
                <div id="buzzer-alert"></div>
            </div>
        </main>

        <aside class="display-scoreboard">
            <h2>📊 Classement en direct</h2>
            <div id="players-ranking"></div>
        </aside>

        <div id="final-results" class="final-screen">
            <h1>🎉 R&eacute;sultats finaux 🎉</h1>
            <div id="podium"></div>
        </div>
    </div>

    <audio id="buzzer-sound" preload="auto">
        <source src="{{ url_for('static', filename='buzzer.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="timer-sound" preload="auto">
        <source src="{{ url_for('static', filename='timer.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="correct-sound" preload="auto">
        <source src="{{ url_for('static', filename='correct.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="wrong-sound" preload="auto">
        <source src="{{ url_for('static', filename='wrong.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="timeout-sound" preload="auto">
        <source src="{{ url_for('static', filename='timeout.mp3') }}" type="audio/mpeg">
    </audio>

    <script>
        const socket = io();
        const roomId = '{{ room_id or "default" }}';
        let timer = 20;
        let timerInterval;
        let timerAudio = null;
        let gameData = {};
        let currentQuestionKey = null;
        let timerActive = false;
        let pendingFinalResultsRequest = false;
        let finalResultsFetchAttempted = false;
        let finalResultsShown = false;

        function updateTimer(timeLeft) {
            timer = timeLeft;
            document.getElementById('timer').textContent = timer;
            const percentage = (timer / 20) * 100;
            document.getElementById('timer-progress').style.width = percentage + '%';
            
            if (timer <= 10) {
                document.getElementById('timer-progress').style.background = 'linear-gradient(90deg, #ff4444, #cc0000)';
            } else if (timer <= 20) {
                document.getElementById('timer-progress').style.background = 'linear-gradient(90deg, #FFA500, #FF8C00)';
            } else {
                document.getElementById('timer-progress').style.background = 'linear-gradient(90deg, #FFD700, #FFA500)';
            }
        }

        function startTimer() {
            clearInterval(timerInterval);
            if (timerAudio) {
                timerAudio.pause();
            }
            timer = 20;
            updateTimer(timer);
            
            // Démarrer la musique du timer
            timerAudio = document.getElementById('timer-sound');
            if (timerAudio) {
                timerAudio.currentTime = 0;
                timerAudio.loop = true;
                timerAudio.play().catch(e => {});
            }
            
            timerInterval = setInterval(() => {
                timer--;
                updateTimer(timer);
                
                if (timer <= 0) {
                    clearInterval(timerInterval);
                    if (timerAudio) {
                        timerAudio.pause();
                    }
                    // Jouer le son timeout
                    const timeoutAudio = document.getElementById('timeout-sound');
                    timeoutAudio.currentTime = 0;
                    timeoutAudio.play().catch(e => {});
                    
                    socket.emit('time_up', {room_id: roomId});
                }
            }, 1000);
            timerActive = true;
        }

        function pauseTimer() {
            clearInterval(timerInterval);
            if (timerAudio) {
                timerAudio.pause();
            }
            timerActive = false;
        }
        
        function resumeTimer() {
            if (timer > 0) {
                clearInterval(timerInterval);
                if (!timerAudio) {
                    timerAudio = document.getElementById('timer-sound');
                }
                timerInterval = setInterval(() => {
                    timer--;
                    updateTimer(timer);
                    
                    if (timer <= 0) {
                        clearInterval(timerInterval);
                        if (timerAudio) {
                            timerAudio.pause();
                        }
                        const timeoutAudio = document.getElementById('timeout-sound');
                        timeoutAudio.currentTime = 0;
                        timeoutAudio.play().catch(e => {});
                        
                        socket.emit('time_up', {room_id: roomId});
                    }
                }, 1000);
                
                if (timerAudio && timerAudio.paused) {
                    timerAudio.play().catch(e => {});
                }
                timerActive = true;
            }
        }

        function updateRanking(players) {
            const ranking = document.getElementById('players-ranking');
            const sortedPlayers = Object.entries(players || {})
                .sort(([,a], [,b]) => b.score - a.score);

            if (sortedPlayers.length === 0) {
                ranking.innerHTML = `
                    <div class="player-rank empty-state">
                        <span class="player-name">Aucun joueur pour le moment</span>
                    </div>
                `;
                return;
            }
            
            ranking.innerHTML = '';
            const medals = ['🥇', '🥈', '🥉'];
            
            sortedPlayers.forEach(([name, data], index) => {
                const div = document.createElement('div');
                div.className = `player-rank rank-${index + 1}`;
                const badge = medals[index] || '⭐';
                div.innerHTML = `
                    <span class="rank-number">${badge}</span>
                    <span class="player-name">${name}</span>
                    <span class="player-score">${data.score} pts</span>
                `;
                ranking.appendChild(div);
            });
        }

        socket.on('game_update', function(data) {
            console.log('Mise à jour du jeu:', data);
            gameData = data;

            if (finalResultsShown) {
                updateRanking(data.players);
                if (data.game_finished) {
                    showFinalResults();
                }
                return;
            }
            
            if (data.current_question) {
                const questionKey = `${data.question_number}-${data.current_question.question}`;
                const isNewQuestion = questionKey !== currentQuestionKey;

                if (isNewQuestion) {
                    currentQuestionKey = questionKey;
                    console.log('Démarrage du timer');
                    startTimer();
                } else if (!data.timer_paused && !data.buzzer_pressed && !timerActive) {
                    console.log('Reprise du timer');
                    resumeTimer();
                }

                console.log('Nouvelle question:', data.current_question.question);
                document.getElementById('question-number').textContent = 
                    `Question ${data.question_number} / ${data.total_questions}`;
                document.getElementById('question-text').textContent = data.current_question.question;
            } else {
                currentQuestionKey = null;
                document.getElementById('question-number').textContent = 'En attente...';
                document.getElementById('question-text').textContent = 'Préparation de la prochaine question';
            }
            
            updateRanking(data.players);
            
            if (!data.buzzer_pressed) {
                document.getElementById('buzzer-alert').textContent = '';
            }

            if (data.game_finished && !finalResultsShown) {
                finalResultsShown = true;
                showFinalResults();
            }
        });

        socket.on('buzzer_activated', function(data) {
            if (finalResultsShown) return;
            console.log('Buzzer activé par:', data.player);
            // Son buzzer
            const buzzerAudio = document.getElementById('buzzer-sound');
            buzzerAudio.currentTime = 0;
            buzzerAudio.play().catch(e => {
                // Fallback son généré
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.type = 'square';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                } catch(err) {
                    console.log('Son non disponible');
                }
            });
            
            // Arrêter la musique du timer
            if (timerAudio) {
                timerAudio.pause();
            }
            
            document.getElementById('buzzer-alert').innerHTML = 
                `🚨 <strong>${data.player}</strong> a buzzé ! 🚨`;
            pauseTimer();
        });

        socket.on('game_finished', function() {
            clearInterval(timerInterval);
            if (timerAudio) {
                timerAudio.pause();
            }
            timerActive = false;
            currentQuestionKey = null;
        });
        
        socket.on('show_final_results', function() {
            if (finalResultsShown) return;
            finalResultsShown = true;
            showFinalResults();
        });
        
        function showFinalResults() {
            const finalSection = document.getElementById('final-results');
            finalSection.classList.add('visible');
            finalSection.setAttribute('aria-hidden', 'false');
            
            const podium = document.getElementById('podium');
            podium.innerHTML = '';

            const playerEntries = Object.entries(gameData.players || {});

            if (playerEntries.length === 0) {
                if (!finalResultsFetchAttempted) {
                    finalResultsFetchAttempted = true;
                    podium.innerHTML = `<div class="loading-results">Récupération des scores...</div>`;
                    if (!pendingFinalResultsRequest) {
                        pendingFinalResultsRequest = true;
                        socket.emit('get_final_results', {room_id: roomId});
                    }
                } else {
                    podium.innerHTML = `<div class="no-results">Aucun joueur à afficher</div>`;
                }
                return;
            }

            pendingFinalResultsRequest = false;
            finalResultsFetchAttempted = true;

            const sortedPlayers = playerEntries.sort(([,a], [,b]) => b.score - a.score);
            const topPlayers = sortedPlayers.slice(0, 3);

            const positions = ['1er', '2ème', '3ème'];
            
            // Afficher seulement les joueurs avec des scores > 0
            const winners = sortedPlayers.filter(([name, data]) => data.score > 0).slice(0, 3);
            
            // Animation séquentielle des gagnants
            winners.forEach(([name, data], index) => {
                setTimeout(() => {
                    const div = document.createElement('div');
                    div.className = `podium-place place-${index + 1} animate-in`;
                    
                    div.innerHTML = `
                        <div class="trophy">${trophies[index]}</div>
                        <div class="winner-name">${name}</div>
                        <div class="winner-score">${data.score} points</div>
                        <div class="position">${positions[index] || `${index + 1}ème`}</div>
                    </div>
                `;
                podium.appendChild(card);
                requestAnimationFrame(() => card.classList.add('animate-in'));
            });
            
            // Si aucun gagnant, afficher un message
            if (winners.length === 0) {
                podium.innerHTML = '<div class="no-winners">Aucun joueur n\'a marqué de points</div>';
            }
        }

        socket.on('play_sound', function(data) {
            console.log('Jouer son:', data.sound);
            const audio = document.getElementById(data.sound + '-sound');
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(e => console.log('Son non disponible:', e));
            } else {
                console.log('Audio non trouvé:', data.sound + '-sound');
            }
        });
        
        socket.on('resume_timer', function() {
            if (finalResultsShown) return;
            console.log('Reprise du timer');
            resumeTimer();
        });
        
        socket.on('pause_timer', function() {
            if (finalResultsShown) return;
            console.log('Pause du timer');
            pauseTimer();
        });

        function hideFinalResults() {
            const finalSection = document.getElementById('final-results');
            finalSection.classList.remove('visible');
            finalSection.setAttribute('aria-hidden', 'true');
            pendingFinalResultsRequest = false;
            finalResultsFetchAttempted = false;
            document.getElementById('podium').innerHTML = '';
        }

        hideFinalResults();

        socket.on('final_results', function(players) {
            pendingFinalResultsRequest = false;
            if (players && typeof players === 'object') {
                gameData.players = players;
                if (!finalResultsShown) {
                    updateRanking(players);
                }
                if (finalResultsShown || (gameData && gameData.game_finished)) {
                    showFinalResults();
                }
            }
        });

        socket.on('game_started', function() {
            finalResultsShown = false;
            currentQuestionKey = null;
            timerActive = false;
            hideFinalResults();
            document.getElementById('question-number').textContent = 'Préparation...';
            document.getElementById('question-text').textContent = 'Le jeu va commencer, préparez-vous !';
            document.getElementById('buzzer-alert').textContent = '';
        });

        socket.on('game_reset', function() {
            finalResultsShown = false;
            currentQuestionKey = null;
            timerActive = false;
            hideFinalResults();
            document.getElementById('question-number').textContent = 'En attente...';
            document.getElementById('question-text').textContent = 'Le jeu va bientôt commencer !';
            document.getElementById('buzzer-alert').textContent = '';
            updateRanking({});
        });

        socket.on('connect', function() {
            console.log('Écran de projection connecté');
            socket.emit('join_room', {room_id: roomId});
            
            // Forcer la mise à jour initiale
            setTimeout(() => {
                socket.emit('join_room', {room_id: roomId});
            }, 1000);
        });
        
        // Debug des évènements
        socket.on('disconnect', function() {
            console.log('Déconnecté de la projection');
        });
        
        socket.on('reconnect', function() {
            console.log('Reconnecté à la projection');
            socket.emit('join_room', {room_id: roomId});
        });
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log('Erreur plein écran:', err);
                });
                document.getElementById('fullscreen-btn').textContent = '❌ Quitter';
            } else {
                document.exitFullscreen();
                document.getElementById('fullscreen-btn').textContent = '📺 Plein écran';
            }
        }
        
        document.addEventListener('fullscreenchange', function() {
            if (!document.fullscreenElement) {
                document.getElementById('fullscreen-btn').textContent = '📺 Plein écran';
            }
        });
    </script>
</body>
</html>


