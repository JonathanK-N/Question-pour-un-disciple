<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âcran de Projection</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body class="display-page">
    <div class="display-container">
        <header class="display-header">
            <h1>üèÜ Question pour un Disciple üèÜ</h1>
            <div class="timer-section">
                <div id="timer">20</div>
                <div class="timer-bar">
                    <div id="timer-progress"></div>
                </div>
            </div>
            <button id="fullscreen-btn" onclick="toggleFullscreen()">üì∫ Plein √©cran</button>
        </header>

        <main class="display-main">
            <div class="question-display">
                <div id="question-number">En attente...</div>
                <div id="question-text">Le jeu va bient√¥t commencer !</div>
                <div id="buzzer-alert"></div>
            </div>
        </main>

        <aside class="display-scoreboard">
            <h2>üèÖ Classement</h2>
            <div id="players-ranking"></div>
        </aside>

        <div id="final-results" class="final-screen" style="display:none;">
            <h1>üéâ R√©sultats Finaux üéâ</h1>
            <div id="podium"></div>
        </div>
    </div>

    <audio id="buzzer-sound" preload="auto">
        <source src="{{ url_for('static', filename='buzzer.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="timer-sound" preload="auto">
        <source src="{{ url_for('static', filename='timer.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="correct-sound" preload="auto">
        <source src="{{ url_for('static', filename='correct.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="wrong-sound" preload="auto">
        <source src="{{ url_for('static', filename='wrong.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="timeout-sound" preload="auto">
        <source src="{{ url_for('static', filename='timeout.mp3') }}" type="audio/mpeg">
    </audio>

    <script>
        const socket = io();
        let timer = 20;
        let timerInterval;

        function updateTimer(timeLeft) {
            timer = timeLeft;
            document.getElementById('timer').textContent = timer;
            const percentage = (timer / 20) * 100;
            document.getElementById('timer-progress').style.width = percentage + '%';
            
            if (timer <= 10) {
                document.getElementById('timer-progress').style.background = 'linear-gradient(90deg, #ff4444, #cc0000)';
            } else if (timer <= 20) {
                document.getElementById('timer-progress').style.background = 'linear-gradient(90deg, #FFA500, #FF8C00)';
            } else {
                document.getElementById('timer-progress').style.background = 'linear-gradient(90deg, #FFD700, #FFA500)';
            }
        }

        function startTimer() {
            timer = 20;
            updateTimer(timer);
            
            timerInterval = setInterval(() => {
                timer--;
                updateTimer(timer);
                
                if (timer <= 0) {
                    clearInterval(timerInterval);
                    // Son de fin de temps
                    const timeoutAudio = document.getElementById('timeout-sound');
                    timeoutAudio.currentTime = 0;
                    timeoutAudio.play().catch(e => console.log('Son timeout non disponible'));
                    const roomId = '{{ room_id or "default" }}';
                    socket.emit('time_up', {room_id: roomId});
                }
            }, 1000);
        }

        function pauseTimer() {
            clearInterval(timerInterval);
        }

        function updateRanking(players) {
            const sortedPlayers = Object.entries(players || {})
                .sort(([,a], [,b]) => b.score - a.score);
            
            const ranking = document.getElementById('players-ranking');
            ranking.innerHTML = '';
            
            sortedPlayers.forEach(([name, data], index) => {
                const div = document.createElement('div');
                div.className = `player-rank rank-${index + 1}`;
                div.innerHTML = `
                    <span class="rank-number">${index + 1}</span>
                    <span class="player-name">${name}</span>
                    <span class="player-score">${data.score}</span>
                `;
                ranking.appendChild(div);
            });
        }

        socket.on('game_update', function(data) {
            if (data.current_question) {
                document.getElementById('question-number').textContent = 
                    `Question ${data.question_number} / ${data.total_questions}`;
                document.getElementById('question-text').textContent = data.current_question.question;
                
                if (!data.timer_paused && !data.buzzer_pressed) {
                    startTimer();
                    // Son timer au d√©but de la question
                    const timerAudio = document.getElementById('timer-sound');
                    timerAudio.currentTime = 0;
                    timerAudio.play().catch(e => console.log('Son timer non disponible'));
                } else if (data.timer_paused) {
                    pauseTimer();
                }
            }
            
            updateRanking(data.players);
            
            if (!data.buzzer_pressed) {
                document.getElementById('buzzer-alert').textContent = '';
            }
        });

        socket.on('buzzer_activated', function(data) {
            // Son buzzer
            const buzzerAudio = document.getElementById('buzzer-sound');
            buzzerAudio.currentTime = 0;
            buzzerAudio.play().catch(e => {
                // Fallback son g√©n√©r√©
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.type = 'square';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                } catch(err) {
                    console.log('Son non disponible');
                }
            });
            
            document.getElementById('buzzer-alert').innerHTML = 
                `üö® <strong>${data.player}</strong> a buzz√© ! üö®`;
            pauseTimer();
        });

        socket.on('game_finished', function() {
            clearInterval(timerInterval);
            setTimeout(() => {
                showFinalResults();
            }, 2000);
        });

        function showFinalResults() {
            const sortedPlayers = Object.entries(gameData.players || {})
                .sort(([,a], [,b]) => b.score - a.score);
            
            document.querySelector('.display-container').style.display = 'none';
            document.getElementById('final-results').style.display = 'flex';
            
            const podium = document.getElementById('podium');
            podium.innerHTML = '';
            
            const trophies = ['ü•á', 'ü•à', 'ü•â'];
            const positions = ['1er', '2√®me', '3√®me'];
            
            // Animation s√©quentielle des 3 premiers
            sortedPlayers.slice(0, 3).forEach(([name, data], index) => {
                setTimeout(() => {
                    const div = document.createElement('div');
                    div.className = `podium-place place-${index + 1} animate-in`;
                    
                    div.innerHTML = `
                        <div class="trophy">${trophies[index]}</div>
                        <div class="winner-name">${name}</div>
                        <div class="winner-score">${data.score} points</div>
                        <div class="position">${positions[index]}</div>
                    `;
                    podium.appendChild(div);
                }, index * 1000);
            });
        }

        socket.on('play_sound', function(data) {
            const audio = document.getElementById(data.sound + '-sound');
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(e => console.log('Son non disponible'));
            }
        });

        socket.on('connect', function() {
            console.log('√âcran de projection connect√©');
            const roomId = '{{ room_id or "default" }}';
            socket.emit('join_room', {room_id: roomId});
        });
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log('Erreur plein √©cran:', err);
                });
                document.getElementById('fullscreen-btn').textContent = '‚ùå Quitter';
            } else {
                document.exitFullscreen();
                document.getElementById('fullscreen-btn').textContent = 'üì∫ Plein √©cran';
            }
        }
        
        document.addEventListener('fullscreenchange', function() {
            if (!document.fullscreenElement) {
                document.getElementById('fullscreen-btn').textContent = 'üì∫ Plein √©cran';
            }
        });
    </script>
</body>
</html>