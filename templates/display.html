<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ã‰cran de Projection</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body class="display-page">
    <div class="display-container">
        <header class="display-header">
            <h1>ðŸ† Question pour un Disciple ðŸ†</h1>
            <div class="timer-section">
                <div id="timer">20</div>
                <div class="timer-bar">
                    <div id="timer-progress"></div>
                </div>
            </div>
            <button id="fullscreen-btn" onclick="toggleFullscreen()">ðŸ“º Plein Ã©cran</button>
        </header>

        <main class="display-main">
            <div class="question-display">
                <div id="question-number">En attente...</div>
                <div id="question-text">Le jeu va bientÃ´t commencer !</div>
                <div id="buzzer-alert"></div>
            </div>
        </main>

        <aside class="display-scoreboard">
            <h2>ðŸ… Classement</h2>
            <div id="players-ranking"></div>
        </aside>

        <div id="final-results" class="final-screen" style="display:none;">
            <h1>ðŸŽ‰ RÃ©sultats Finaux ðŸŽ‰</h1>
            <div id="podium"></div>
        </div>
    </div>

    <audio id="buzzer-sound" preload="auto">
        <source src="{{ url_for('static', filename='buzzer.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="timer-sound" preload="auto">
        <source src="{{ url_for('static', filename='timer.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="correct-sound" preload="auto">
        <source src="{{ url_for('static', filename='correct.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="wrong-sound" preload="auto">
        <source src="{{ url_for('static', filename='wrong.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="timeout-sound" preload="auto">
        <source src="{{ url_for('static', filename='timeout.mp3') }}" type="audio/mpeg">
    </audio>

    <script>
        const socket = io();
        let timer = 20;
        let timerInterval;
        let timerAudio = null;
        let gameData = {};

        function updateTimer(timeLeft) {
            timer = timeLeft;
            document.getElementById('timer').textContent = timer;
            const percentage = (timer / 20) * 100;
            document.getElementById('timer-progress').style.width = percentage + '%';
            
            if (timer <= 10) {
                document.getElementById('timer-progress').style.background = 'linear-gradient(90deg, #ff4444, #cc0000)';
            } else if (timer <= 20) {
                document.getElementById('timer-progress').style.background = 'linear-gradient(90deg, #FFA500, #FF8C00)';
            } else {
                document.getElementById('timer-progress').style.background = 'linear-gradient(90deg, #FFD700, #FFA500)';
            }
        }

        function startTimer() {
            clearInterval(timerInterval);
            if (timerAudio) {
                timerAudio.pause();
            }
            timer = 20;
            updateTimer(timer);
            
            // DÃ©marrer la musique du timer
            timerAudio = document.getElementById('timer-sound');
            if (timerAudio) {
                timerAudio.currentTime = 0;
                timerAudio.loop = true;
                timerAudio.play().catch(e => {});
            }
            
            timerInterval = setInterval(() => {
                timer--;
                updateTimer(timer);
                
                if (timer <= 0) {
                    clearInterval(timerInterval);
                    if (timerAudio) {
                        timerAudio.pause();
                    }
                    // Jouer le son timeout
                    const timeoutAudio = document.getElementById('timeout-sound');
                    timeoutAudio.currentTime = 0;
                    timeoutAudio.play().catch(e => {});
                    
                    const roomId = '{{ room_id or "default" }}';
                    socket.emit('time_up', {room_id: roomId});
                }
            }, 1000);
        }

        function pauseTimer() {
            clearInterval(timerInterval);
            if (timerAudio) {
                timerAudio.pause();
            }
        }
        
        function resumeTimer() {
            if (timer > 0) {
                clearInterval(timerInterval);
                if (!timerAudio) {
                    timerAudio = document.getElementById('timer-sound');
                }
                timerInterval = setInterval(() => {
                    timer--;
                    updateTimer(timer);
                    
                    if (timer <= 0) {
                        clearInterval(timerInterval);
                        if (timerAudio) {
                            timerAudio.pause();
                        }
                        const timeoutAudio = document.getElementById('timeout-sound');
                        timeoutAudio.currentTime = 0;
                        timeoutAudio.play().catch(e => {});
                        
                        const roomId = '{{ room_id or "default" }}';
                        socket.emit('time_up', {room_id: roomId});
                    }
                }, 1000);
                
                if (timerAudio && timerAudio.paused) {
                    timerAudio.play().catch(e => {});
                }
            }
        }

        function updateRanking(players) {
            const sortedPlayers = Object.entries(players || {})
                .sort(([,a], [,b]) => b.score - a.score);
            
            const ranking = document.getElementById('players-ranking');
            ranking.innerHTML = '';
            
            sortedPlayers.forEach(([name, data], index) => {
                const div = document.createElement('div');
                div.className = `player-rank rank-${index + 1}`;
                div.innerHTML = `
                    <span class="rank-number">${index + 1}</span>
                    <span class="player-name">${name}</span>
                    <span class="player-score">${data.score}</span>
                `;
                ranking.appendChild(div);
            });
        }

        socket.on('game_update', function(data) {
            console.log('Game update reÃ§u:', data);
            gameData = data;
            
            if (data.current_question) {
                console.log('Nouvelle question:', data.current_question.question);
                document.getElementById('question-number').textContent = 
                    `Question ${data.question_number} / ${data.total_questions}`;
                document.getElementById('question-text').textContent = data.current_question.question;
                
                if (!data.timer_paused && !data.buzzer_pressed) {
                    console.log('DÃ©marrage du timer');
                    startTimer();
                }
            }
            
            updateRanking(data.players);
            
            if (!data.buzzer_pressed) {
                document.getElementById('buzzer-alert').textContent = '';
            }
        });

        socket.on('buzzer_activated', function(data) {
            console.log('Buzzer activÃ© par:', data.player);
            // Son buzzer
            const buzzerAudio = document.getElementById('buzzer-sound');
            buzzerAudio.currentTime = 0;
            buzzerAudio.play().catch(e => {
                // Fallback son gÃ©nÃ©rÃ©
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.type = 'square';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                } catch(err) {
                    console.log('Son non disponible');
                }
            });
            
            // ArrÃªter la musique du timer
            if (timerAudio) {
                timerAudio.pause();
            }
            
            document.getElementById('buzzer-alert').innerHTML = 
                `ðŸš¨ <strong>${data.player}</strong> a buzzÃ© ! ðŸš¨`;
            pauseTimer();
        });

        socket.on('game_finished', function() {
            clearInterval(timerInterval);
            if (timerAudio) {
                timerAudio.pause();
            }
        });
        
        socket.on('show_final_results', function() {
            showFinalResults();
        });
        
        function showFinalResults() {
            const sortedPlayers = Object.entries(gameData.players || {})
                .sort(([,a], [,b]) => b.score - a.score);
            
            document.querySelector('.display-container').style.display = 'none';
            document.getElementById('final-results').style.display = 'flex';
            
            const podium = document.getElementById('podium');
            podium.innerHTML = '';
            
            const trophies = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'];
            const positions = ['1er', '2Ã¨me', '3Ã¨me'];
            
            // Animation sÃ©quentielle des 3 premiers
            sortedPlayers.slice(0, 3).forEach(([name, data], index) => {
                setTimeout(() => {
                    const div = document.createElement('div');
                    div.className = `podium-place place-${index + 1} animate-in`;
                    
                    div.innerHTML = `
                        <div class="trophy">${trophies[index]}</div>
                        <div class="winner-name">${name}</div>
                        <div class="winner-score">${data.score} points</div>
                        <div class="position">${positions[index]}</div>
                    `;
                    podium.appendChild(div);
                }, index * 1000);
            });
        }

        socket.on('play_sound', function(data) {
            console.log('Jouer son:', data.sound);
            const audio = document.getElementById(data.sound + '-sound');
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(e => console.log('Son non disponible:', e));
            } else {
                console.log('Audio non trouvÃ©:', data.sound + '-sound');
            }
        });
        
        socket.on('resume_timer', function() {
            console.log('Reprise du timer');
            resumeTimer();
        });
        
        socket.on('pause_timer', function() {
            console.log('Pause du timer');
            pauseTimer();
        });

        socket.on('connect', function() {
            console.log('Ã‰cran de projection connectÃ©');
            const roomId = '{{ room_id or "default" }}';
            socket.emit('join_room', {room_id: roomId});
            
            // Forcer la mise Ã  jour initiale
            setTimeout(() => {
                socket.emit('join_room', {room_id: roomId});
            }, 1000);
        });
        
        // Debug des Ã©vÃ©nements
        socket.on('disconnect', function() {
            console.log('DÃ©connectÃ© de la projection');
        });
        
        socket.on('reconnect', function() {
            console.log('ReconnectÃ© Ã  la projection');
            const roomId = '{{ room_id or "default" }}';
            socket.emit('join_room', {room_id: roomId});
        });
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log('Erreur plein Ã©cran:', err);
                });
                document.getElementById('fullscreen-btn').textContent = 'âŒ Quitter';
            } else {
                document.exitFullscreen();
                document.getElementById('fullscreen-btn').textContent = 'ðŸ“º Plein Ã©cran';
            }
        }
        
        document.addEventListener('fullscreenchange', function() {
            if (!document.fullscreenElement) {
                document.getElementById('fullscreen-btn').textContent = 'ðŸ“º Plein Ã©cran';
            }
        });
    </script>
</body>
</html>
